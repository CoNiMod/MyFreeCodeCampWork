# -*- coding: utf-8 -*-
"""fcc_book_recommendation_knn.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/github/freeCodeCamp/boilerplate-book-recommendation-engine/blob/master/fcc_book_recommendation_knn.ipynb
"""

# import libraries (you may add additional imports but you may not have to)
import numpy as np
import pandas as pd
from scipy.sparse import csr_matrix
from sklearn.neighbors import NearestNeighbors
import matplotlib.pyplot as plt

# get data files
# !wget https://cdn.freecodecamp.org/project-data/books/book-crossings.zip
# !unzip book-crossings.zip

books_filename = 'BX-Books.csv'
ratings_filename = 'BX-Book-Ratings.csv'

# import csv data into dataframes
df_books = pd.read_csv(
    books_filename,
    encoding = "ISO-8859-1",
    sep=";",
    header=0,
    names=['isbn', 'title', 'author'],
    usecols=['isbn', 'title', 'author'],
    dtype={'isbn': 'str', 'title': 'str', 'author': 'str'})

df_ratings = pd.read_csv(
    ratings_filename,
    encoding = "ISO-8859-1",
    sep=";",
    header=0,
    names=['user', 'isbn', 'rating'],
    usecols=['user', 'isbn', 'rating'],
    dtype={'user': 'int32', 'isbn': 'str', 'rating': 'float32'})

# add your code here - consider creating a new cell for each section of code

# æ•°æ®é¢„å¤„ç†ï¼šè¿‡æ»¤æ‰è¯„åˆ†å°‘äº200çš„ç”¨æˆ·å’Œè¯„åˆ†å°‘äº100çš„å›¾ä¹¦
# ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„è¯„åˆ†æ•°é‡
user_rating_counts = df_ratings['user'].value_counts()
# ç»Ÿè®¡æ¯æœ¬ä¹¦çš„è¯„åˆ†æ•°é‡
book_rating_counts = df_ratings['isbn'].value_counts()

# è¿‡æ»¤ç”¨æˆ·å’Œå›¾ä¹¦
filtered_users = user_rating_counts[user_rating_counts >= 200].index
filtered_books = book_rating_counts[book_rating_counts >= 100].index

# åº”ç”¨è¿‡æ»¤
df_ratings_filtered = df_ratings[
    (df_ratings['user'].isin(filtered_users)) & 
    (df_ratings['isbn'].isin(filtered_books))
]

# åˆ›å»ºç”¨æˆ·-å›¾ä¹¦è¯„åˆ†çŸ©é˜µ
# å°†ç”¨æˆ·å’Œå›¾ä¹¦IDè½¬æ¢ä¸ºè¿ç»­çš„æ•´æ•°ç´¢å¼•
user_id_map = {user_id: idx for idx, user_id in enumerate(filtered_users)}
book_id_map = {book_isbn: idx for idx, book_isbn in enumerate(filtered_books)}

# åˆ›å»ºç¨€ç–çŸ©é˜µ
rows = [user_id_map[user_id] for user_id in df_ratings_filtered['user']]
cols = [book_id_map[book_isbn] for book_isbn in df_ratings_filtered['isbn']]
data = df_ratings_filtered['rating'].values

# åˆ›å»ºç¨€ç–çŸ©é˜µ
rating_matrix = csr_matrix((data, (rows, cols)), 
                          shape=(len(filtered_users), len(filtered_books)))

# è®­ç»ƒKNNæ¨¡å‹
# è½¬ç½®çŸ©é˜µï¼Œä½¿å¾—æ¯æœ¬ä¹¦æˆä¸ºä¸€ä¸ªç‰¹å¾å‘é‡ï¼ˆæ¯è¡Œä»£è¡¨ä¸€æœ¬ä¹¦ï¼Œæ¯åˆ—ä»£è¡¨ä¸€ä¸ªç”¨æˆ·ï¼‰
rating_matrix_transposed = rating_matrix.T
knn_model = NearestNeighbors(metric='cosine', algorithm='brute')
knn_model.fit(rating_matrix_transposed)

# åˆ›å»ºåå‘æ˜ å°„ï¼šä»ç´¢å¼•åˆ°å›¾ä¹¦ISBN
book_id_reverse_map = {idx: book_isbn for book_isbn, idx in book_id_map.items()}

# function to return recommended books - this will be tested
def get_recommends(book = ""):
    # æŸ¥æ‰¾å›¾ä¹¦åœ¨æ•°æ®é›†ä¸­çš„ç´¢å¼•
    book_row = df_books[df_books['title'] == book]
    
    if book_row.empty:
        return [book, []]
    
    book_isbn = book_row.iloc[0]['isbn']
    
    # æ£€æŸ¥å›¾ä¹¦æ˜¯å¦åœ¨è¿‡æ»¤åçš„æ•°æ®é›†ä¸­
    if book_isbn not in book_id_map:
        return [book, []]
    
    book_idx = book_id_map[book_isbn]
    
    # è·å–è¯¥å›¾ä¹¦çš„è¯„åˆ†å‘é‡
    book_ratings = rating_matrix[:, book_idx].toarray().flatten()
    
    # ä½¿ç”¨KNNæ‰¾åˆ°æœ€ç›¸ä¼¼çš„å›¾ä¹¦
    # é‡å¡‘æ•°æ®ä»¥åŒ¹é…sklearnçš„æœŸæœ›æ ¼å¼
    book_ratings_reshaped = book_ratings.reshape(1, -1)
    
    # æ‰¾åˆ°æœ€è¿‘çš„é‚»å±…ï¼ˆæ’é™¤è‡ªå·±ï¼‰
    distances, indices = knn_model.kneighbors(book_ratings_reshaped, n_neighbors=6)
    
    # æ„å»ºæ¨èåˆ—è¡¨
    recommended_books = []
    for i in range(1, 6):  # è·³è¿‡ç¬¬ä¸€ä¸ªï¼ˆè‡ªå·±ï¼‰
        neighbor_idx = indices[0][i]
        distance = distances[0][i]
        
        # ä»ç´¢å¼•è·å–å›¾ä¹¦ISBN
        neighbor_isbn = book_id_reverse_map[neighbor_idx]
        
        # ä»ISBNè·å–å›¾ä¹¦æ ‡é¢˜
        neighbor_title = df_books[df_books['isbn'] == neighbor_isbn]['title'].iloc[0]
        
        recommended_books.append([neighbor_title, distance])
    
    return [book, recommended_books]

books = get_recommends("Where the Heart Is (Oprah's Book Club (Paperback))")
print(books)

def test_book_recommendation():
  test_pass = True
  recommends = get_recommends("Where the Heart Is (Oprah's Book Club (Paperback))")
  if recommends[0] != "Where the Heart Is (Oprah's Book Club (Paperback))":
    test_pass = False
  recommended_books = ["I'll Be Seeing You", 'The Weight of Water', 'The Surgeon', 'I Know This Much Is True']
  recommended_books_dist = [0.8, 0.77, 0.77, 0.77]
  for i in range(2):
    if recommends[1][i][0] not in recommended_books:
      test_pass = False
    if abs(recommends[1][i][1] - recommended_books_dist[i]) >= 0.05:
      test_pass = False
  if test_pass:
    print("You passed the challenge! ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰")
  else:
    print("You haven't passed yet. Keep trying!")

test_book_recommendation()